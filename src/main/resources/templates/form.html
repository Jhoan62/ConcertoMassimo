<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Ordine Ticket</title>
  <link rel="stylesheet" href="/css/styleForm.css">
</head>
<body>
<nav class="navbar">
  <div class="nav-left">
    <span>Italia / € EUR</span>
    <a href="/contattaci">Contattaci</a>
  </div>
  <div class="nav-center">
    <a href="/homepage" class="logo">
      <img src="/img/P Logo .png" alt="Logo" style="height: 65px;">
    </a>
    <ul>
      <li><a th:href="@{/controller/eventi}">EVENTI IN CORSO</a></li>
    </ul>
  </div>
  <div class="nav-right">
    <i class="fas fa-search"></i>
    <i class="far fa-heart"></i>
    <i class="fas fa-shopping-bag"></i>
  </div>
</nav>

<div class="container">
  <!-- SEZIONE SINISTRA: FORM -->
  <div class="form-section">
    <form action="/controller/ticket" method="post">
      <input type="hidden" name="_csrf" value="${_csrf.token}" />
      <h2>Metodo di Consegna</h2>
      <div class="delivery-method">
        <div class="radio-group">
          <input type="radio" id="consegna1" name="metodoConsegna" value="corriere" checked />
          <label for="consegna1">Corriere Espresso (Consegna entro 2-3 giorni lavorativi)</label>
        </div>
        <div class="radio-group">
          <input type="radio" id="consegna2" name="metodoConsegna" value="digitale" />
          <label for="consegna2">Invio digitale (PDF stampabile)</label>
        </div>
        <div class="radio-group">
          <input type="radio" id="consegna3" name="metodoConsegna" value="ritiro" />
          <label for="consegna3">Ritiro in negozio</label>
        </div>
      </div>
      <h2>I tuoi dati</h2>
      <div class="form-group">
        <label for="tipologia">Tipologia</label>
        <select id="tipologia" name="tipologia">
          <option value="privato">Privato</option>
          <option value="azienda">Azienda</option>
        </select>
      </div>
      <div class="form-group">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" placeholder="Mario" />
      </div>
      <div class="form-group">
        <label for="cognome">Cognome</label>
        <input type="text" id="cognome" name="cognome" placeholder="Rossi" />
      </div>
      <div class="form-group">
        <label for="dataNascita">Data di nascita</label>
        <input type="date" id="dataNascita" name="dataNascita" />
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="esempio@email.com" />
      </div>
      <div class="form-group">
        <label for="confermaEmail">Conferma Email</label>
        <input type="email" id="confermaEmail" name="confermaEmail" placeholder="esempio@email.com" />
      </div>
      <div class="form-group">
        <label for="nazione">Nazione</label>
        <select id="nazione" name="nazione">
          <option value="IT">Italia</option>
          <option value="US">Stati Uniti</option>
          <option value="DE">Germania</option>
        </select>
      </div>
      <div class="form-group">
        <label for="provincia">Provincia</label>
        <input type="text" id="provincia" name="provincia" placeholder="Es: MI" />
      </div>
      <div class="form-group">
        <label for="citta">Città</label>
        <input type="text" id="citta" name="citta" placeholder="Milano" />
      </div>
      <div class="form-group">
        <label for="indirizzo">Indirizzo</label>
        <input type="text" id="indirizzo" name="indirizzo" placeholder="Via Roma" />
      </div>
      <div class="form-group">
        <label for="civico">Numero Civico</label>
        <input type="text" id="civico" name="civico" placeholder="10" />
      </div>
      <div class="form-group">
        <label for="cap">CAP</label>
        <input type="number" id="cap" name="cap" placeholder="20100" />
      </div>
      <div id="fattura-differente" class="checkbox-group">
        <input type="checkbox" id="checkFatturaDifferente" name="fatturaDifferente" />
        <label for="checkFatturaDifferente">Indica un indirizzo diverso per la fattura</label>
      </div>
      <div id="fattura-differente-fields">
        <div class="form-group">
          <label for="fatturaIndirizzo">Indirizzo per la fattura</label>
          <input type="text" id="fatturaIndirizzo" name="fatturaIndirizzo" placeholder="Via Fatture" />
        </div>
        <div class="form-group">
          <label for="fatturaCivico">Numero Civico</label>
          <input type="text" id="fatturaCivico" name="fatturaCivico" placeholder="15" />
        </div>
        <div class="form-group">
          <label for="fatturaCap">CAP</label>
          <input type="number" id="fatturaCap" name="fatturaCap" placeholder="20100" />
        </div>
        <div class="form-group">
          <label for="fatturaCitta">Città</label>
          <input type="text" id="fatturaCitta" name="fatturaCitta" placeholder="Milano" />
        </div>
      </div>
      <div class="privacy-section">
        <h2>Preferenze Privacy</h2>
        <p>Seleziona la tua preferenza sul trattamento dei dati per finalità di marketing.</p>
        <div class="privacy-options">
          <div class="radio-group">
            <input type="radio" id="privacySi" name="privacyMarketing" value="si" />
            <label for="privacySi">Acconsento</label>
          </div>
          <div class="radio-group">
            <input type="radio" id="privacyNo" name="privacyMarketing" value="no" checked />
            <label for="privacyNo">Non Acconsento</label>
          </div>
        </div>
      </div>
      <!-- Bottone di submit -->
      <button type="submit" class="btn-submit" id="payButton">Vai al pagamento</button>
    </form>
  </div>

  <!-- SEZIONE DESTRA: RIEPILOGO -->
  <div class="summary-section">
    <h3>Riepilogo</h3>
    <div class="summary-item">
      <span>Biglietto</span>
      <!-- Qui usiamo degli id per aggiornare dinamicamente il valore -->
      <span id="ticketPriceDisplay">€ 0,00</span>
    </div>
    <div class="summary-item">
      <span>Commissioni di servizio</span>
      <span>€ 9,90</span>
    </div>
    <div class="summary-item">
      <span>IVA</span>
      <span>€ 5,60</span>
    </div>
    <div class="summary-total">
      <span>Totale</span>
      <span id="totalPriceDisplay">€ 0,00</span>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // VALIDAZIONI PER I CAMPI DELLA CARTA (se presenti in una sezione successiva)
    const cardNumberInput = document.getElementById('cardNumber');
    const expiryDateInput = document.getElementById('expiryDate');
    const cvvInput = document.getElementById('cvv');
    const cardHolderInput = document.getElementById('cardHolder');

    const cardNumberError = document.getElementById('cardNumberError');
    const expiryDateError = document.getElementById('expiryDateError');
    const cvvError = document.getElementById('cvvError');
    const cardHolderError = document.getElementById('cardHolderError');

    function formatCardNumber(value) {
      return value.replace(/\D/g, '').replace(/(.{4})/g, '$1 ').trim();
    }

    function formatExpiryDate(value) {
      value = value.replace(/\D/g, '');
      if (value.length > 2) {
        return value.substring(0,2) + '/' + value.substring(2,4);
      }
      return value;
    }

    if(cardNumberInput){
      cardNumberInput.addEventListener('input', function() {
        const formatted = formatCardNumber(cardNumberInput.value);
        cardNumberInput.value = formatted;
        if (formatted.replace(/\s/g, '').length > 16) {
          cardNumberInput.value = formatted.substring(0, 19);
        }
        validateCardNumber();
      });
    }

    if(cardHolderInput){
      cardHolderInput.addEventListener('input', function() {
        // Rimuove numeri
        cardHolderInput.value = cardHolderInput.value.replace(/[0-9]/g, '');
        validateCardHolder();
      });
    }

    if(expiryDateInput){
      expiryDateInput.addEventListener('input', function() {
        const formatted = formatExpiryDate(expiryDateInput.value);
        expiryDateInput.value = formatted;
        validateExpiryDate();
      });
    }

    if(cvvInput){
      cvvInput.addEventListener('input', function() {
        cvvInput.value = cvvInput.value.replace(/\D/g, '');
        validateCVV();
      });
    }

    function validateCardNumber() {
      if(cardNumberInput){
        const value = cardNumberInput.value.replace(/\s+/g, '');
        if (!/^\d{16}$/.test(value)) {
          cardNumberError.textContent = 'Inserire esattamente 16 cifre.';
        } else {
          cardNumberError.textContent = '';
        }
      }
    }

    function validateExpiryDate() {
      if(expiryDateInput){
        const value = expiryDateInput.value;
        if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(value)) {
          expiryDateError.textContent = 'Formato non valido. Usa MM/YY.';
        } else {
          expiryDateError.textContent = '';
        }
      }
    }

    function validateCVV() {
      if(cvvInput){
        const value = cvvInput.value;
        if (!/^\d{3}$/.test(value)) {
          cvvError.textContent = 'Inserire un CVV di 3 cifre.';
        } else {
          cvvError.textContent = '';
        }
      }
    }

    function validateCardHolder() {
      if(cardHolderInput){
        const value = cardHolderInput.value.trim();
        if (value.length < 3) {
          cardHolderError.textContent = 'Inserire il nome del titolare (min. 3 caratteri).';
        } else {
          cardHolderError.textContent = '';
        }
      }
    }

    // VALIDAZIONI PER I CAMPI ANAGRAFICI

    // Campi in cui NON devono comparire numeri
    const textOnlyFields = ['nome', 'cognome', 'provincia', 'citta', 'indirizzo'];
    textOnlyFields.forEach(function (id) {
      const field = document.getElementById(id);
      if (field) {
        field.addEventListener('input', function () {
          this.value = this.value.replace(/[0-9]/g, '');
        });
      }
    });

    // Campo Provincia: oltre a rimuovere i numeri, limita a 2 lettere (es. MI)
    const provinciaField = document.getElementById('provincia');
    if (provinciaField) {
      provinciaField.addEventListener('input', function() {
        this.value = this.value.replace(/[^A-Za-z]/g, '');
        if (this.value.length > 2) {
          this.value = this.value.slice(0,2);
        }
      });
    }

    // Campi che devono contenere solo numeri: Numero Civico e CAP
    const numericOnlyFields = ['civico', 'cap'];
    numericOnlyFields.forEach(function (id) {
      const field = document.getElementById(id);
      if (field) {
        field.addEventListener('input', function () {
          this.value = this.value.replace(/[^\d]/g, '');
        });
      }
    });
    // Limiti specifici per Numero Civico (max 4 cifre) e CAP (max 5 cifre)
    const civicoField = document.getElementById('civico');
    if (civicoField) {
      civicoField.addEventListener('input', function() {
        if(this.value.length > 4){
          this.value = this.value.slice(0, 4);
        }
      });
    }
    const capField = document.getElementById('cap');
    if (capField) {
      capField.addEventListener('input', function() {
        if(this.value.length > 5){
          this.value = this.value.slice(0, 5);
        }
      });
    }

    // Controllo finale al click su "Vai al pagamento"
    const payButton = document.getElementById('payButton');
    payButton.addEventListener('click', function(event) {
      validateCardNumber();
      validateExpiryDate();
      validateCVV();
      validateCardHolder();

      // Se ci sono errori nei campi della carta (se presenti), blocca l'invio del form.
      if ((cardNumberError && cardNumberError.textContent) ||
              (expiryDateError && expiryDateError.textContent) ||
              (cvvError && cvvError.textContent) ||
              (cardHolderError && cardHolderError.textContent)) {
        event.preventDefault();
        alert('Correggi gli errori nei dati della carta (se presenti) prima di procedere.');
      }
    });
  });
</script>
<script src="/js/scriptForm.js"></script>
</body>
</html>
